# Makefile for WordPress development shortcuts
# MyProject Project - Optimized commands for daily development

# === PROJECT URLS ===
LOCAL_URL := https://local.MyProject.com/
PREPROD_URL := https://dev.MyProject.levelstage.com/

.PHONY: help install dev build format lint test clean health
.PHONY: fix quick commit-ready dev-blocks dev-theme clear-cache
.PHONY: dev-flat101 status update check-deps quick-fix dev-watch
.PHONY: performance-check new-block open-local open-preprod
.PHONY: lighthouse-local lighthouse-preprod sync-from-preprod
.PHONY: debug-theme debug-blocks debug-assets debug-performance
.PHONY: test-unit test-e2e test-a11y test-security test-complete
.PHONY: monitor-setup generate-reports

help: ## Show this help
	@echo ""
	@echo "üöÄ MyProject WordPress Development Commands"
	@echo ""
	@echo "Main commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "For more information: README.md"
	@echo ""

# === INITIAL SETUP ===

install: ## Install all dependencies (npm + composer)
	@echo "üîß Installing project dependencies..."
	npm install
	@echo "üì¶ Installing root Composer dependencies..."
	composer install
	@echo "üì¶ Installing plugin dependencies..."
	cd wordpress/wp-content/plugins/my-project-custom-blocks && npm install && composer install
	@echo "üé® Installing starter theme dependencies..."
	cd wordpress/wp-content/themes/flat101-starter-theme && npm install && composer install
	@echo "üé® Installing main theme dependencies..."
	cd wordpress/wp-content/themes/my-project-theme && npm install && composer install
	@echo "‚úÖ Installation complete"

check-deps: ## Check for outdated dependencies
	@echo "üîç Checking dependencies..."
	npm run health:check:outdated

update: ## Update dependencies (use with caution)
	@echo "‚¨ÜÔ∏è Updating dependencies..."
	npm update
	composer update
	cd wordpress/wp-content/plugins/my-project-custom-blocks && npm update && composer update
	cd wordpress/wp-content/themes/flat101-starter-theme && npm update && composer update
	cd wordpress/wp-content/themes/my-project-theme && npm update && composer update
	@echo "‚úÖ Dependencies updated"

# === DEVELOPMENT ===

dev: ## üöÄ Start parallel development (all components with hot reload)
	@echo "üöÄ Starting parallel development..."
	npm run dev:all

dev-blocks: ## üß© Development for Gutenberg blocks only
	@echo "üß© Starting blocks development..."
	npm run dev:blocks

dev-theme: ## üé® Development for main theme (my-project-theme)
	@echo "üé® Starting main theme development..."
	npm run dev:MyProject

dev-flat101: ## Development for starter theme (flat101-starter-theme)
	@echo "üé® Starting starter theme development..."
	npm run dev:flat101

dev-watch: ## üöÄ Development with file watching and auto-reload
	@echo "üëÄ Starting development with file watching..."
	npm-run-all --parallel dev:all watch:reload

quick-fix: ## ‚ö° Quick format + lint + test cycle
	@echo "üîß Quick fix cycle..."
	@make format
	@make lint-quick
	@make quick
	@echo "‚úÖ Ready for commit!"

new-block: ## üß© Create new Gutenberg block with boilerplate
	@read -p "Block name: " name; \
	cd wordpress/wp-content/plugins/my-project-custom-blocks && \
	npx @wordpress/create-block $$name --no-wp-scripts

performance-check: ## üìä Run performance analysis
	@echo "‚ö° Checking performance..."
	@npm run analyze:bundle-size 2>/dev/null || echo "‚ö†Ô∏è  Bundle analyzer not configured yet"
	@npm run test:lighthouse 2>/dev/null || echo "‚ö†Ô∏è  Lighthouse tests not configured yet"
	@echo "üìä Performance report generated"

# === BUILD AND PRODUCTION ===

build: ## üì¶ Create optimized production build (minified, compressed)
	@echo "üèóÔ∏è Generating production build..."
	npm run build:production
	@echo "‚úÖ Build completed"

# === FORMATTING AND LINTING ===

format: ## üíÖ Format all code (PHP, JS, CSS) according to WordPress standards
	@echo "‚ú® Formatting code..."
	npm run fix-all
	@echo "‚úÖ Code formatted"

fix: format ## Alias for format

lint: ## Run complete linting without changes
	@echo "üîç Checking code standards..."
	npm run test:standards

lint-quick: ## Quick linting (JS/CSS only)
	@echo "‚ö° Quick verification..."
	npm run test:standards:quick

# === VERIFICATION AND TESTING ===

test: ## ‚úÖ Run complete quality verification (linting + standards + security)
	@echo "üß™ Running complete verification..."
	npm run verify:standards
	@echo "‚úÖ Verification completed"

quick: ## Quick verification before commit
	@echo "‚ö° Quick verification..."
	npm run quick-check

commit-ready: ## Verify ready for commit
	@echo "üìù Verifying commit readiness..."
	npm run pre-commit:full
	@echo "‚úÖ Ready for commit"

# === PROJECT URLS AND TOOLS ===

open-local: ## üåê Open local development site
	@echo "üåê Opening local site..."
	@open $(LOCAL_URL)

open-preprod: ## üåê Open preprod site
	@echo "üåê Opening preprod site..."
	@open $(PREPROD_URL)

sync-from-preprod: ## üîÑ Sync database from preprod
	@echo "üîÑ Syncing from preprod..."
	@echo "‚ö†Ô∏è  Database sync commands to be configured with WP-CLI"
	# Add WP-CLI commands for database sync

lighthouse-local: ## üîç Run Lighthouse on local
	@echo "üîç Running Lighthouse on local site..."
	@mkdir -p reports
	@npx lighthouse $(LOCAL_URL) --output=html --output-path=./reports/lighthouse-local.html --quiet
	@echo "üìä Local Lighthouse report: ./reports/lighthouse-local.html"

lighthouse-preprod: ## üîç Run Lighthouse on preprod
	@echo "üîç Running Lighthouse on preprod site..."
	@mkdir -p reports
	@npx lighthouse $(PREPROD_URL) --output=html --output-path=./reports/lighthouse-preprod.html --quiet
	@echo "üìä Preprod Lighthouse report: ./reports/lighthouse-preprod.html"

# === DEBUGGING COMMANDS ===

debug-theme: ## üêõ Debug theme issues
	@echo "üêõ Theme debugging..."
	@echo "üìÅ Checking theme structure:"
	@ls -la wordpress/wp-content/themes/my-project-theme/ | head -10
	@echo "\nüîç Searching for error logs and console.log:"
	@grep -r "error_log\|console.log" wordpress/wp-content/themes/my-project-theme/ 2>/dev/null || echo "No error logs found"
	@echo "\nüì¶ Checking theme assets:"
	@ls -la wordpress/wp-content/themes/my-project-theme/assets/build/ 2>/dev/null || echo "Build directory not found - run make build"
	@echo "\n‚öôÔ∏è Checking functions.php:"
	@head -20 wordpress/wp-content/themes/my-project-theme/functions.php 2>/dev/null || echo "functions.php not found"

debug-blocks: ## üß© Debug block registration issues
	@echo "üß© Block debugging..."
	@echo "üìÅ Checking blocks structure:"
	@ls -la wordpress/wp-content/plugins/my-project-custom-blocks/src/blocks/ 2>/dev/null || echo "Blocks directory not found"
	@echo "\nüîç Searching for registerBlockType:"
	@grep -r "registerBlockType" wordpress/wp-content/plugins/my-project-custom-blocks/src/ 2>/dev/null || echo "No block registrations found"
	@echo "\nüì¶ Checking block builds:"
	@ls -la wordpress/wp-content/plugins/my-project-custom-blocks/build/ 2>/dev/null || echo "Build directory not found - run make build"
	@echo "\nüìã Checking block.json files:"
	@find wordpress/wp-content/plugins/my-project-custom-blocks/src/blocks/ -name "block.json" 2>/dev/null || echo "No block.json files found"

debug-assets: ## üì¶ Debug asset loading issues
	@echo "üì¶ Asset debugging..."
	@echo "üîç Checking built assets:"
	@find wordpress/wp-content/themes/*/assets/build/ -name "*.js" -o -name "*.css" 2>/dev/null | head -10 || echo "No built assets found"
	@echo "\nüìã Checking asset enqueuing:"
	@grep -r "wp_enqueue" wordpress/wp-content/themes/my-project-theme/inc/ 2>/dev/null || echo "No enqueue functions found"
	@echo "\nüìä Asset sizes:"
	@du -sh wordpress/wp-content/themes/*/assets/build/* 2>/dev/null || echo "No assets to analyze"
	@echo "\nüîß Checking webpack config:"
	@ls -la wordpress/wp-content/themes/my-project-theme/webpack.config.js 2>/dev/null || echo "webpack.config.js not found"

debug-performance: ## ‚ö° Debug performance issues
	@echo "‚ö° Performance debugging..."
	@echo "üìä Bundle sizes:"
	@npm run analyze:bundle-size
	@echo "\nüîç PHP analysis:"
	@npm run analyze:php 2>/dev/null || echo "PHP analysis not available"
	@echo "\nüì¶ Dependency analysis:"
	@npm run analyze:dependencies 2>/dev/null || echo "Dependency analysis not available"
	@echo "\nüóÇÔ∏è Cache status:"
	@ls -la .eslintcache .stylelintcache 2>/dev/null || echo "No cache files found"

# === TESTING COMMANDS ===

test-unit: ## üß™ Run unit tests
	@echo "üß™ Running unit tests..."
	@npm run test:unit 2>/dev/null || echo "‚ö†Ô∏è  Unit tests not configured yet. Run: npm install --save-dev jest"

test-e2e: ## üé≠ Run end-to-end tests
	@echo "üé≠ Running E2E tests..."
	@npm run test:e2e 2>/dev/null || echo "‚ö†Ô∏è  E2E tests not configured yet. Playwright is available in blocks plugin."

test-a11y: ## ‚ôø Run accessibility tests
	@echo "‚ôø Running accessibility tests..."
	@npm run test:a11y 2>/dev/null || echo "‚ö†Ô∏è  A11y tests not configured yet. Run: npm install -g pa11y-ci"

test-security: ## üîí Run security audit
	@echo "üîí Running security audit..."
	@npm run analyze:security

test-complete: ## ‚úÖ Run all tests
	@echo "‚úÖ Running complete test suite..."
	@make test-security
	@make test-unit
	@make test-a11y
	@echo "üìä Test summary completed"

# === MONITORING AND REPORTS ===

monitor-setup: ## üìä Setup monitoring tools
	@echo "üìä Setting up monitoring tools..."
	@npm list -g lighthouse 2>/dev/null || echo "Installing Lighthouse globally..." && npm install -g lighthouse
	@npm list -g pa11y-ci 2>/dev/null || echo "Installing Pa11y globally..." && npm install -g pa11y-ci
	@echo "‚úÖ Monitoring tools setup completed"

generate-reports: ## üìà Generate comprehensive project reports
	@echo "üìà Generating comprehensive reports..."
	@mkdir -p reports
	@make lighthouse-local 2>/dev/null || echo "‚ö†Ô∏è  Local site not accessible"
	@make lighthouse-preprod 2>/dev/null || echo "‚ö†Ô∏è  Preprod site not accessible"
	@npm run test:a11y > reports/accessibility-report.txt 2>/dev/null || echo "‚ö†Ô∏è  A11y tests not configured"
	@npm run analyze:bundle-size > reports/bundle-analysis.txt 2>/dev/null || echo "Bundle analysis saved"
	@npm run analyze:security > reports/security-audit.txt 2>/dev/null || echo "Security audit saved"
	@echo "üìä Reports generated in ./reports/"
	@ls -la reports/

# === MAINTENANCE ===

clean: ## üßπ Clean all caches and temporary files
	@echo "üßπ Cleaning temporary files..."
	npm run clean:all
	@echo "‚úÖ Cleanup completed"

clear-cache: ## Clear all caches (ESLint, Stylelint, PHPCS, Prettier)
	@echo "üóëÔ∏è Clearing caches..."
	npm run cache:clear
	@echo "‚úÖ Caches cleared"

health: ## üè• Check project health (dependencies, configs, standards)
	@echo "üè• Checking project health..."
	npm run health:check
	@echo "‚úÖ Health check completed"

status: ## Show current project status
	@echo ""
	@echo "üìä MyProject Project Status"
	@echo "============================"
	@echo ""
	@echo "üìÅ Project structure:"
	@ls -la wordpress/wp-content/plugins/ | grep MyProject || echo "  ‚ùå Plugin not found"
	@ls -la wordpress/wp-content/themes/ | grep -E "(flat101|MyProject)" || echo "  ‚ùå Themes not found"
	@echo ""
	@echo "üì¶ Dependencies installed:"
	@test -d node_modules && echo "  ‚úÖ Root dependencies installed" || echo "  ‚ùå Root dependencies missing"
	@test -d wordpress/wp-content/plugins/my-project-custom-blocks/node_modules && echo "  ‚úÖ Plugin dependencies installed" || echo "  ‚ùå Plugin dependencies missing"
	@test -d wordpress/wp-content/themes/my-project-theme/node_modules && echo "  ‚úÖ Theme dependencies installed" || echo "  ‚ùå Theme dependencies missing"
	@test -d wordpress/wp-content/themes/flat101-starter-theme/node_modules && echo "  ‚úÖ Starter theme dependencies installed" || echo "  ‚ùå Starter theme dependencies missing"
	@test -d vendor && echo "  ‚úÖ Root composer dependencies installed" || echo "  ‚ùå Root composer dependencies missing"
	@test -d wordpress/wp-content/plugins/my-project-custom-blocks/vendor && echo "  ‚úÖ Plugin composer dependencies installed" || echo "  ‚ùå Plugin composer dependencies missing"
	@test -d wordpress/wp-content/themes/my-project-theme/vendor && echo "  ‚úÖ Main theme composer dependencies installed" || echo "  ‚ùå Main theme composer dependencies missing"
	@test -d wordpress/wp-content/themes/flat101-starter-theme/vendor && echo "  ‚úÖ Starter theme composer dependencies installed" || echo "  ‚ùå Starter theme composer dependencies missing"
	@echo ""
	@echo "üîß For more commands: make help"
	@echo ""

# === SHORTCUTS AND ALIASES ===

# Common aliases for quick development
start: dev ## Alias for dev
serve: dev ## Alias for dev
watch: dev ## Alias for dev

# Aliases for verification
check: quick ## Alias for quick
verify: test ## Alias for test

# Aliases for cleanup
reset: clean ## Alias for clean
flush: clear-cache ## Alias for clear-cache

# === CI/CD COMMANDS ===

# Environment URLs
STAGING_URL := https://dev.MyProject.levelstage.com
PRODUCTION_URL := https://MyProject.com

deploy-staging: ## üöÄ Deploy to staging environment
	@echo "üöÄ Deploying to staging..."
	@echo "üìã Pre-deployment checks..."
	@make test-complete
	@echo "üì¶ Building assets..."
	@make build
	@echo "üîÑ Syncing to staging: $(STAGING_URL)"
	@./sh/deploy/deploy.sh staging
	@echo "‚úÖ Staging deployment completed"
	@echo "üåê Visit: $(STAGING_URL)"

deploy-prod: ## üåü Deploy to production environment
	@echo "üåü Deploying to production..."
	@echo "‚ö†Ô∏è  WARNING: This will deploy to PRODUCTION!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@echo "üìã Pre-deployment checks..."
	@make test-complete
	@echo "üì¶ Building assets..."
	@make build
	@echo "üîÑ Syncing to production: $(PRODUCTION_URL)"
	@./sh/deploy/deploy.sh production
	@echo "‚úÖ Production deployment completed"
	@echo "üåê Visit: $(PRODUCTION_URL)"

rollback-staging: ## ‚è™ Rollback staging to previous version
	@echo "‚è™ Rolling back staging..."
	@./sh/deploy/rollback.sh staging
	@echo "‚úÖ Staging rollback completed"

rollback-prod: ## üîÑ Rollback production to previous version
	@echo "üîÑ Rolling back production..."
	@echo "‚ö†Ô∏è  WARNING: This will rollback PRODUCTION!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@./sh/deploy/rollback.sh production
	@echo "‚úÖ Production rollback completed"

# === DATABASE SYNC COMMANDS ===

db-backup: ## üíæ Create database backup
	@./sh/wp/simple-db-backup.sh

db-backup-simple: ## üíæ Create simple database backup (Docker direct)
	@./sh/wp/simple-db-backup.sh

# Docker-specific database commands
db-pull: ## üì• Pull database from Levelstage to Docker local (with URL replacement)
	@echo "üì• Pulling database from Levelstage to Docker local..."
	@./sh/wp/docker-db-sync.sh pull

db-push: ## üì§ Push Docker local database to Levelstage (with URL replacement)
	@echo "üì§ Pushing Docker local database to Levelstage..."
	@./sh/wp/docker-db-sync.sh push

db-pull-dry: ## üîç Preview pull from Levelstage (dry run)
	@echo "üîç Preview: Pull database from Levelstage..."
	@./sh/wp/docker-db-sync.sh pull --dry-run

db-push-dry: ## üîç Preview push to Levelstage (dry run)
	@echo "üîç Preview: Push database to Levelstage..."
	@./sh/wp/docker-db-sync.sh push --dry-run

# Legacy commands (for non-Docker environments)
db-sync-from-staging: ## üì• Sync database from staging to local (legacy)
	@echo "üì• Syncing database from staging..."
	@echo "‚ö†Ô∏è  WARNING: This will overwrite your local database!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@make db-backup
	@./sh/wp/sync-db.sh staging local
	@echo "‚úÖ Database sync from staging completed"

db-sync-from-prod: ## üì• Sync database from production to local (legacy)
	@echo "üì• Syncing database from production..."
	@echo "‚ö†Ô∏è  WARNING: This will overwrite your local database!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@make db-backup
	@./sh/wp/sync-db.sh production local
	@echo "‚úÖ Database sync from production completed"

db-push-to-staging: ## üì§ Push local database to staging (legacy)
	@echo "üì§ Pushing database to staging..."
	@echo "‚ö†Ô∏è  WARNING: This will overwrite staging database!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@./sh/wp/sync-db.sh local staging
	@echo "‚úÖ Database push to staging completed"

# === BACKUP COMMANDS ===

backup-full: ## üíæ Create full project backup
	@echo "üíæ Creating full project backup..."
	@mkdir -p backups/full
	@make db-backup
	@echo "üìÅ Backing up files..."
	@tar -czf backups/full/files-$(shell date +%Y%m%d-%H%M%S).tar.gz wordpress/wp-content/uploads/
	@echo "‚úÖ Full backup completed"

backup-code: ## üíæ Create code backup (themes and plugins)
	@echo "üíæ Creating code backup..."
	@mkdir -p backups/code
	@tar -czf backups/code/code-$(shell date +%Y%m%d-%H%M%S).tar.gz wordpress/wp-content/themes/ wordpress/wp-content/plugins/my-project-custom-blocks/
	@echo "‚úÖ Code backup completed"

# === LIGHTHOUSE CI COMMANDS ===

lighthouse-ci-setup: ## üèÆ Setup Lighthouse CI
	@echo "üèÆ Setting up Lighthouse CI..."
	@npm install -g @lhci/cli
	@echo "üìù Creating Lighthouse CI config..."
	@echo "module.exports = {" > lighthouserc.js
	@echo "  ci: {" >> lighthouserc.js
	@echo "    collect: {" >> lighthouserc.js
	@echo "      url: ['$(LOCAL_URL)', '$(LOCAL_URL)/about/', '$(LOCAL_URL)/contact/']," >> lighthouserc.js
	@echo "      startServerCommand: 'make dev-server'," >> lighthouserc.js
	@echo "      startServerReadyPattern: 'ready'," >> lighthouserc.js
	@echo "      numberOfRuns: 3" >> lighthouserc.js
	@echo "    }," >> lighthouserc.js
	@echo "    assert: {" >> lighthouserc.js
	@echo "      assertions: {" >> lighthouserc.js
	@echo "        'categories:performance': ['warn', {minScore: 0.8}]," >> lighthouserc.js
	@echo "        'categories:accessibility': ['error', {minScore: 0.9}]," >> lighthouserc.js
	@echo "        'categories:best-practices': ['warn', {minScore: 0.8}]," >> lighthouserc.js
	@echo "        'categories:seo': ['warn', {minScore: 0.8}]" >> lighthouserc.js
	@echo "      }" >> lighthouserc.js
	@echo "    }," >> lighthouserc.js
	@echo "    upload: {" >> lighthouserc.js
	@echo "      target: 'filesystem'," >> lighthouserc.js
	@echo "      outputDir: './reports/lighthouse-ci'" >> lighthouserc.js
	@echo "    }" >> lighthouserc.js
	@echo "  }" >> lighthouserc.js
	@echo "};" >> lighthouserc.js
	@echo "‚úÖ Lighthouse CI setup completed"

lighthouse-ci-run: ## üèÆ Run Lighthouse CI analysis
	@echo "üèÆ Running Lighthouse CI analysis..."
	@mkdir -p reports/lighthouse-ci
	@lhci collect --url=https://local.MyProject.com/ --url=https://local.MyProject.com/about/ --url=https://local.MyProject.com/contact/ --numberOfRuns=3
	@lhci assert --preset=lighthouse:recommended
	@lhci upload --target=filesystem --outputDir=./reports/lighthouse-ci
	@echo "‚úÖ Lighthouse CI analysis completed"
	@echo "üìä Reports available in: reports/lighthouse-ci/"

# === NOTIFICATION COMMANDS ===

notify-deployment: ## üì¢ Send deployment notification
	@echo "üì¢ Sending deployment notification..."
	@echo "üöÄ Deployment completed at $(shell date)" | tee -a deployment.log
	@echo "‚úÖ Notification sent"
