# Makefile for WordPress development shortcuts
# {{PROJECT_NAME}} Project - Optimized commands for daily development

# === PROJECT URLS ===
LOCAL_URL := https://local.{{PROJECT_SLUG}}.com/
PREPROD_URL := https://dev.{{PROJECT_SLUG}}.levelstage.com/
STAGING_URL := https://dev.{{PROJECT_SLUG}}.levelstage.com
PRODUCTION_URL := https://{{PROJECT_SLUG}}.com

# === WORDPRESS CONTENT DIRECTORY ===
WP_CONTENT_DIR := {{WP_CONTENT_DIR}}

.PHONY: help install dev build format lint test clean health
.PHONY: fix quick commit-ready clear-cache status update check-deps quick-fix
.PHONY: performance-check open-local open-preprod sync-from-preprod
.PHONY: debug-assets debug-performance test-unit test-e2e test-a11y test-security test-complete
.PHONY: monitor-setup generate-reports dev-all build-all lint-all format-all
# Component-specific targets will be added dynamically
{{COMPONENT_PHONY_TARGETS}}

help: ## Show this help
	@echo ""
	@echo "ğŸš€ {{PROJECT_NAME}} WordPress Development Commands"
	@echo ""
	@echo "ğŸ“‹ Main commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-25s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ§© Component-specific commands:"
{{COMPONENT_HELP_TARGETS}}
	@echo ""
	@echo "ğŸ“– For more information: README.md"
	@echo ""

# === INITIAL SETUP ===

install: ## Install all dependencies (npm + composer)
	@echo "ğŸ”§ Installing {{PROJECT_NAME}} project dependencies..."
	@echo "ğŸ“¦ Installing root dependencies..."
	npm install
	composer install
{{COMPONENT_INSTALL_TARGETS}}
	@echo "âœ… Installation complete for {{PROJECT_NAME}}"

check-deps: ## Check for outdated dependencies
	@echo "ğŸ” Checking dependencies..."
	npm run health:check:outdated

update: ## Update dependencies (use with caution)
	@echo "â¬†ï¸ Updating {{PROJECT_NAME}} dependencies..."
	npm update
	composer update
{{COMPONENT_UPDATE_TARGETS}}
	@echo "âœ… Dependencies updated for {{PROJECT_NAME}}"

# === DEVELOPMENT ===

dev: dev-all ## ğŸš€ Start parallel development (all components with hot reload)

dev-all: ## ğŸš€ Start development for all selected components
	@echo "ğŸš€ Starting parallel development for {{PROJECT_NAME}}..."
{{COMPONENT_DEV_ALL_TARGETS}}
	@echo "âœ… All development servers started"

build: build-all ## ğŸ“¦ Create optimized production build (all components)

build-all: ## ğŸ“¦ Build all selected components
	@echo "ğŸ—ï¸ Building all {{PROJECT_NAME}} components..."
{{COMPONENT_BUILD_ALL_TARGETS}}
	@echo "âœ… All components built successfully"

quick-fix: ## âš¡ Quick format + lint + test cycle
	@echo "ğŸ”§ Quick fix cycle for {{PROJECT_NAME}}..."
	@make format-all
	@make lint-all
	@make quick
	@echo "âœ… Ready for commit!"

performance-check: ## ğŸ“Š Run performance analysis
	@echo "âš¡ Checking {{PROJECT_NAME}} performance..."
	@npm run analyze:bundle-size 2>/dev/null || echo "âš ï¸  Bundle analyzer not configured yet"
	@npm run test:lighthouse 2>/dev/null || echo "âš ï¸  Lighthouse tests not configured yet"
	@echo "ğŸ“Š Performance report generated"

# === COMPONENT-SPECIFIC DEVELOPMENT TARGETS ===
{{COMPONENT_DEV_TARGETS}}

# === COMPONENT-SPECIFIC BUILD TARGETS ===
{{COMPONENT_BUILD_TARGETS}}

# === FORMATTING AND LINTING ===

format: format-all ## ğŸ’… Format all code (PHP, JS, CSS) according to WordPress standards

format-all: ## ğŸ’… Format all selected components
	@echo "âœ¨ Formatting {{PROJECT_NAME}} code..."
	@echo "ğŸ”§ Formatting PHP code..."
	@./vendor/bin/phpcbf --standard=phpcs.xml.dist 2>/dev/null || echo "âš ï¸  PHPCBF not available - run 'composer install'"
	@echo "ğŸ”§ Formatting JavaScript code..."
	@npx eslint --fix '**/*.{js,jsx,ts,tsx}' 2>/dev/null || echo "âš ï¸  ESLint not available - run 'npm install'"
{{COMPONENT_FORMAT_TARGETS}}
	@echo "âœ… All code formatted"

lint: lint-all ## ğŸ” Run complete linting without changes

lint-all: ## ğŸ” Lint all selected components
	@echo "ğŸ” Checking {{PROJECT_NAME}} code standards..."
	@echo "ğŸ” Checking PHP standards..."
	@./vendor/bin/phpcs --standard=phpcs.xml.dist 2>/dev/null || echo "âš ï¸  PHPCS not available - run 'composer install'"
	@echo "ğŸ” Checking JavaScript standards..."
	@npx eslint '**/*.{js,jsx,ts,tsx}' 2>/dev/null || echo "âš ï¸  ESLint not available - run 'npm install'"
{{COMPONENT_LINT_TARGETS}}
	@echo "âœ… All code checked"

# === COMPONENT-SPECIFIC FORMATTING TARGETS ===
{{COMPONENT_FORMAT_INDIVIDUAL_TARGETS}}

# === COMPONENT-SPECIFIC LINTING TARGETS ===
{{COMPONENT_LINT_INDIVIDUAL_TARGETS}}

fix: format ## Alias for format

lint-quick: ## Quick linting (JS/CSS only)
	@echo "âš¡ Quick {{PROJECT_NAME}} verification..."
	@npx eslint '**/*.{js,jsx,ts,tsx}' 2>/dev/null || echo "âš ï¸  ESLint not available"
	@echo "âœ… Quick verification completed"

# === VERIFICATION AND TESTING ===

test: ## âœ… Run complete quality verification (linting + standards + security)
	@echo "ğŸ§ª Running complete {{PROJECT_NAME}} verification..."
	@make lint-all
	@make test-security
	@echo "âœ… Verification completed"

quick: ## Quick verification before commit
	@echo "âš¡ Quick {{PROJECT_NAME}} verification..."
	@make lint-quick
	@echo "âœ… Quick verification completed"

commit-ready: ## Verify ready for commit
	@echo "ğŸ“ Verifying {{PROJECT_NAME}} commit readiness..."
	@make format-all
	@make lint-all
	@make test-security
	@echo "âœ… Ready for commit"

# === PROJECT URLS AND TOOLS ===

open-local: ## ğŸŒ Open local development site
	@echo "ğŸŒ Opening {{PROJECT_NAME}} local site..."
	@open $(LOCAL_URL)

open-preprod: ## ğŸŒ Open preprod site
	@echo "ğŸŒ Opening {{PROJECT_NAME}} preprod site..."
	@open $(PREPROD_URL)

sync-from-preprod: ## ğŸ”„ Sync database from preprod
	@echo "ğŸ”„ Syncing {{PROJECT_NAME}} from preprod..."
	@echo "âš ï¸  Database sync commands to be configured with WP-CLI"
	# Add WP-CLI commands for database sync

lighthouse-local: ## ğŸ” Run Lighthouse on local
	@echo "ğŸ” Running Lighthouse on {{PROJECT_NAME}} local site..."
	@mkdir -p reports
	@npx lighthouse $(LOCAL_URL) --output=html --output-path=./reports/lighthouse-local.html --quiet
	@echo "ğŸ“Š Local Lighthouse report: ./reports/lighthouse-local.html"

lighthouse-preprod: ## ğŸ” Run Lighthouse on preprod
	@echo "ğŸ” Running Lighthouse on {{PROJECT_NAME}} preprod site..."
	@mkdir -p reports
	@npx lighthouse $(PREPROD_URL) --output=html --output-path=./reports/lighthouse-preprod.html --quiet
	@echo "ğŸ“Š Preprod Lighthouse report: ./reports/lighthouse-preprod.html"

# === DEBUGGING COMMANDS ===

debug-assets: ## ğŸ“¦ Debug asset loading issues
	@echo "ğŸ“¦ {{PROJECT_NAME}} asset debugging..."
	@echo "ğŸ” Checking built assets:"
	@find $(WP_CONTENT_DIR)/themes/*/assets/build/ -name "*.js" -o -name "*.css" 2>/dev/null | head -10 || echo "No built assets found"
	@find $(WP_CONTENT_DIR)/plugins/*/build/ -name "*.js" -o -name "*.css" 2>/dev/null | head -10 || echo "No plugin assets found"
	@echo "\nğŸ“Š Asset sizes:"
	@du -sh $(WP_CONTENT_DIR)/themes/*/assets/build/* 2>/dev/null || echo "No theme assets to analyze"
	@du -sh $(WP_CONTENT_DIR)/plugins/*/build/* 2>/dev/null || echo "No plugin assets to analyze"

debug-performance: ## âš¡ Debug performance issues
	@echo "âš¡ {{PROJECT_NAME}} performance debugging..."
	@echo "ğŸ“Š Bundle sizes:"
	@npm run analyze:bundle-size 2>/dev/null || echo "Bundle analyzer not configured"
	@echo "\nğŸ” PHP analysis:"
	@./vendor/bin/phpstan analyze 2>/dev/null || echo "PHPStan not available - run 'composer install'"
	@echo "\nğŸ—‚ï¸ Cache status:"
	@ls -la .eslintcache .stylelintcache 2>/dev/null || echo "No cache files found"

# === COMPONENT-SPECIFIC DEBUGGING TARGETS ===
{{COMPONENT_DEBUG_TARGETS}}

# === TESTING COMMANDS ===

test-unit: ## ğŸ§ª Run unit tests
	@echo "ğŸ§ª Running unit tests..."
	@npm run test:unit 2>/dev/null || echo "âš ï¸  Unit tests not configured yet. Run: npm install --save-dev jest"

test-e2e: ## ğŸ­ Run end-to-end tests
	@echo "ğŸ­ Running E2E tests..."
	@npm run test:e2e 2>/dev/null || echo "âš ï¸  E2E tests not configured yet. Playwright is available in blocks plugin."

test-a11y: ## â™¿ Run accessibility tests
	@echo "â™¿ Running accessibility tests..."
	@npm run test:a11y 2>/dev/null || echo "âš ï¸  A11y tests not configured yet. Run: npm install -g pa11y-ci"

test-security: ## ğŸ”’ Run security audit
	@echo "ğŸ”’ Running {{PROJECT_NAME}} security audit..."
	@npm audit --audit-level=moderate 2>/dev/null || echo "âš ï¸  npm audit not available"
	@composer audit 2>/dev/null || echo "âš ï¸  composer audit not available"

test-complete: ## âœ… Run all tests
	@echo "âœ… Running complete {{PROJECT_NAME}} test suite..."
	@make test-security
	@make test-unit
	@make test-a11y
	@echo "ğŸ“Š Test summary completed"

# === MONITORING AND REPORTS ===

monitor-setup: ## ğŸ“Š Setup monitoring tools
	@echo "ğŸ“Š Setting up monitoring tools..."
	@npm list -g lighthouse 2>/dev/null || echo "Installing Lighthouse globally..." && npm install -g lighthouse
	@npm list -g pa11y-ci 2>/dev/null || echo "Installing Pa11y globally..." && npm install -g pa11y-ci
	@echo "âœ… Monitoring tools setup completed"

generate-reports: ## ğŸ“ˆ Generate comprehensive project reports
	@echo "ğŸ“ˆ Generating comprehensive {{PROJECT_NAME}} reports..."
	@mkdir -p reports
	@make lighthouse-local 2>/dev/null || echo "âš ï¸  Local site not accessible"
	@make lighthouse-preprod 2>/dev/null || echo "âš ï¸  Preprod site not accessible"
	@make test-a11y > reports/accessibility-report.txt 2>/dev/null || echo "âš ï¸  A11y tests not configured"
	@make test-security > reports/security-audit.txt 2>/dev/null || echo "Security audit saved"
	@echo "ğŸ“Š Reports generated in ./reports/"
	@ls -la reports/

# === MAINTENANCE ===

clean: ## ğŸ§¹ Clean all caches and temporary files
	@echo "ğŸ§¹ Cleaning {{PROJECT_NAME}} temporary files..."
	@rm -rf .eslintcache .stylelintcache
	@rm -rf node_modules/.cache
{{COMPONENT_CLEAN_TARGETS}}
	@echo "âœ… Cleanup completed"

clear-cache: ## Clear all caches (ESLint, Stylelint, PHPCS, Prettier)
	@echo "ğŸ—‘ï¸ Clearing {{PROJECT_NAME}} caches..."
	@rm -rf .eslintcache .stylelintcache
	@rm -rf node_modules/.cache
	@echo "âœ… Caches cleared"

health: ## ğŸ¥ Check project health (dependencies, configs, standards)
	@echo "ğŸ¥ Checking {{PROJECT_NAME}} project health..."
	@make check-deps
	@make lint-quick
	@echo "âœ… Health check completed"

status: ## Show current project status
	@echo ""
	@echo "ğŸ“Š {{PROJECT_NAME}} Project Status"
	@echo "============================"
	@echo ""
	@echo "ğŸ“ Project structure:"
	@ls -la $(WP_CONTENT_DIR)/plugins/ 2>/dev/null | head -5 || echo "  âŒ Plugins directory not found"
	@ls -la $(WP_CONTENT_DIR)/themes/ 2>/dev/null | head -5 || echo "  âŒ Themes directory not found"
	@echo ""
	@echo "ğŸ“¦ Dependencies installed:"
	@test -d node_modules && echo "  âœ… Root dependencies installed" || echo "  âŒ Root dependencies missing"
	@test -d vendor && echo "  âœ… Root composer dependencies installed" || echo "  âŒ Root composer dependencies missing"
{{COMPONENT_STATUS_TARGETS}}
	@echo ""
	@echo "ğŸ”§ For more commands: make help"
	@echo ""

# === SHORTCUTS AND ALIASES ===

# Common aliases for quick development
start: dev ## Alias for dev
serve: dev ## Alias for dev
watch: dev ## Alias for dev

# Aliases for verification
check: quick ## Alias for quick
verify: test ## Alias for test

# Aliases for cleanup
reset: clean ## Alias for clean
flush: clear-cache ## Alias for clear-cache

# === CI/CD COMMANDS ===

deploy-staging: ## ğŸš€ Deploy to staging environment
	@echo "ğŸš€ Deploying {{PROJECT_NAME}} to staging..."
	@echo "ğŸ“‹ Pre-deployment checks..."
	@make test-complete
	@echo "ğŸ“¦ Building assets..."
	@make build-all
	@echo "ğŸ”„ Syncing to staging: $(STAGING_URL)"
	@./sh/deploy/deploy.sh staging 2>/dev/null || echo "âš ï¸  Deploy script not found"
	@echo "âœ… Staging deployment completed"
	@echo "ğŸŒ Visit: $(STAGING_URL)"

deploy-prod: ## ğŸŒŸ Deploy to production environment
	@echo "ğŸŒŸ Deploying {{PROJECT_NAME}} to production..."
	@echo "âš ï¸  WARNING: This will deploy to PRODUCTION!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@echo "ğŸ“‹ Pre-deployment checks..."
	@make test-complete
	@echo "ğŸ“¦ Building assets..."
	@make build-all
	@echo "ğŸ”„ Syncing to production: $(PRODUCTION_URL)"
	@./sh/deploy/deploy.sh production 2>/dev/null || echo "âš ï¸  Deploy script not found"
	@echo "âœ… Production deployment completed"
	@echo "ğŸŒ Visit: $(PRODUCTION_URL)"

rollback-staging: ## âª Rollback staging to previous version
	@echo "âª Rolling back {{PROJECT_NAME}} staging..."
	@./sh/deploy/rollback.sh staging 2>/dev/null || echo "âš ï¸  Rollback script not found"
	@echo "âœ… Staging rollback completed"

rollback-prod: ## ğŸ”„ Rollback production to previous version
	@echo "ğŸ”„ Rolling back {{PROJECT_NAME}} production..."
	@echo "âš ï¸  WARNING: This will rollback PRODUCTION!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ]
	@./sh/deploy/rollback.sh production 2>/dev/null || echo "âš ï¸  Rollback script not found"
	@echo "âœ… Production rollback completed"

# === DATABASE SYNC COMMANDS ===

db-backup: ## ğŸ’¾ Create database backup
	@echo "ğŸ’¾ Creating {{PROJECT_NAME}} database backup..."
	@./sh/wp/simple-db-backup.sh 2>/dev/null || echo "âš ï¸  Database backup script not found"

db-backup-simple: ## ğŸ’¾ Create simple database backup (Docker direct)
	@echo "ğŸ’¾ Creating simple {{PROJECT_NAME}} database backup..."
	@./sh/wp/simple-db-backup.sh 2>/dev/null || echo "âš ï¸  Database backup script not found"

# Docker-specific database commands
db-pull: ## ğŸ“¥ Pull database from Levelstage to Docker local (with URL replacement)
	@echo "ğŸ“¥ Pulling {{PROJECT_NAME}} database from Levelstage to Docker local..."
	@./sh/wp/docker-db-sync.sh pull 2>/dev/null || echo "âš ï¸  Database sync script not found"

db-push: ## ğŸ“¤ Push Docker local database to Levelstage (with URL replacement)
	@echo "ğŸ“¤ Pushing {{PROJECT_NAME}} Docker local database to Levelstage..."
	@./sh/wp/docker-db-sync.sh push 2>/dev/null || echo "âš ï¸  Database sync script not found"

db-pull-dry: ## ğŸ” Preview pull from Levelstage (dry run)
	@echo "ğŸ” Preview: Pull {{PROJECT_NAME}} database from Levelstage..."
	@./sh/wp/docker-db-sync.sh pull --dry-run 2>/dev/null || echo "âš ï¸  Database sync script not found"

db-push-dry: ## ğŸ” Preview push to Levelstage (dry run)
	@echo "ğŸ” Preview: Push {{PROJECT_NAME}} database to Levelstage..."
	@./sh/wp/docker-db-sync.sh push --dry-run 2>/dev/null || echo "âš ï¸  Database sync script not found"

# === BACKUP COMMANDS ===

backup-full: ## ğŸ’¾ Create full project backup
	@echo "ğŸ’¾ Creating full {{PROJECT_NAME}} project backup..."
	@mkdir -p backups/full
	@make db-backup
	@echo "ğŸ“ Backing up files..."
	@tar -czf backups/full/files-$(shell date +%Y%m%d-%H%M%S).tar.gz $(WP_CONTENT_DIR)/uploads/ 2>/dev/null || echo "âš ï¸  Uploads directory not found"
	@echo "âœ… Full backup completed"

backup-code: ## ğŸ’¾ Create code backup (themes and plugins)
	@echo "ğŸ’¾ Creating {{PROJECT_NAME}} code backup..."
	@mkdir -p backups/code
	@tar -czf backups/code/code-$(shell date +%Y%m%d-%H%M%S).tar.gz $(WP_CONTENT_DIR)/themes/ $(WP_CONTENT_DIR)/plugins/ 2>/dev/null || echo "âš ï¸  Some directories not found"
	@echo "âœ… Code backup completed"

# === LIGHTHOUSE CI COMMANDS ===

lighthouse-ci-setup: ## ğŸ® Setup Lighthouse CI
	@echo "ğŸ® Setting up {{PROJECT_NAME}} Lighthouse CI..."
	@npm install -g @lhci/cli 2>/dev/null || echo "âš ï¸  Failed to install Lighthouse CI globally"
	@echo "ğŸ“ Creating Lighthouse CI config..."
	@echo "module.exports = {" > lighthouserc.js
	@echo "  ci: {" >> lighthouserc.js
	@echo "    collect: {" >> lighthouserc.js
	@echo "      url: ['$(LOCAL_URL)', '$(LOCAL_URL)/about/', '$(LOCAL_URL)/contact/']," >> lighthouserc.js
	@echo "      numberOfRuns: 3" >> lighthouserc.js
	@echo "    }," >> lighthouserc.js
	@echo "    assert: {" >> lighthouserc.js
	@echo "      assertions: {" >> lighthouserc.js
	@echo "        'categories:performance': ['warn', {minScore: 0.8}]," >> lighthouserc.js
	@echo "        'categories:accessibility': ['error', {minScore: 0.9}]," >> lighthouserc.js
	@echo "        'categories:best-practices': ['warn', {minScore: 0.8}]," >> lighthouserc.js
	@echo "        'categories:seo': ['warn', {minScore: 0.8}]" >> lighthouserc.js
	@echo "      }" >> lighthouserc.js
	@echo "    }," >> lighthouserc.js
	@echo "    upload: {" >> lighthouserc.js
	@echo "      target: 'filesystem'," >> lighthouserc.js
	@echo "      outputDir: './reports/lighthouse-ci'" >> lighthouserc.js
	@echo "    }" >> lighthouserc.js
	@echo "  }" >> lighthouserc.js
	@echo "};" >> lighthouserc.js
	@echo "âœ… Lighthouse CI setup completed"

lighthouse-ci-run: ## ğŸ® Run Lighthouse CI analysis
	@echo "ğŸ® Running {{PROJECT_NAME}} Lighthouse CI analysis..."
	@mkdir -p reports/lighthouse-ci
	@lhci collect --url=$(LOCAL_URL) --numberOfRuns=3 2>/dev/null || echo "âš ï¸  Lighthouse CI not available"
	@lhci assert --preset=lighthouse:recommended 2>/dev/null || echo "âš ï¸  Lighthouse CI assertions failed"
	@lhci upload --target=filesystem --outputDir=./reports/lighthouse-ci 2>/dev/null || echo "âš ï¸  Lighthouse CI upload failed"
	@echo "âœ… Lighthouse CI analysis completed"
	@echo "ğŸ“Š Reports available in: reports/lighthouse-ci/"

# === NOTIFICATION COMMANDS ===

notify-deployment: ## ğŸ“¢ Send deployment notification
	@echo "ğŸ“¢ Sending {{PROJECT_NAME}} deployment notification..."
	@echo "ğŸš€ {{PROJECT_NAME}} deployment completed at $(shell date)" | tee -a deployment.log
	@echo "âœ… Notification sent"